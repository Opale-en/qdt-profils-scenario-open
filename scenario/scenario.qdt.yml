# yaml-language-server: $schema=https://raw.githubusercontent.com/qgis-deployment/qgis-deployment-toolbelt-cli/refs/heads/main/docs/schemas/scenario/qdt_scenario.json

metadata:
  title: "Scenario déploiement de QDT pour tout Opale"
  id: qdt-scenario-opale
  description: Déploiement des profils QGIS à Opale avec QDT.

settings:
  DEBUG: false
  SCENARIO_VALIDATION: true

steps:
  - name: Set environment variables
    uses: manage-env-vars
    with:
      - name: SIG_RESOURCES_FOLDER
        action: "add"
        scope: "user"
        value: "%USERPROFILE%/Opale Energies Naturelles/Carto - SIG/0_RESSOURCES"
        value_type: path
      - name: PYQGIS_STARTUP
        action: "add"
        scope: "user"
        value: "%USERPROFILE%/Opale Energies Naturelles/Carto - SIG/0_RESSOURCES/2_LOGICIELS/QGIS/pyqgis_startup.py"
        value_type: path

  - name: Trouver l'exécutable de QGIS à utiliser (notamment pour les raccourcis)
    uses: qgis-installation-finder
    with:
      search_paths:
        - "%PROGRAMFILES%\\QGIS"
      version_priority:
        - "3.44.8"
        - "3.40.12"
        - "3.42"
        - "3.36"

  - name: Télécharger les profils depuis le dépôt Git
    uses: qprofiles-downloader
    with:
      protocol: git_remote
      source: https://github.com/Opale-en/qdt-profils-scenario-open.git
      branch: main

  - name: Synchronise les profils locaux avec les profils téléchargés
    uses: qprofiles-synchronizer
    with:
      sync_mode: overwrite

  - name: Télécharger les plugins référencés dans les profils
    uses: qplugins-downloader
    with:
      force: false
      threads: 5

  - name: Synchronise les plugins locaux avec les plugins téléchargés
    uses: qplugins-synchronizer
    with:
      action: create_or_restore
      profile_ref: installed

  - name: Créer les raccourcis pour chaque profil
    uses: shortcuts-manager
    with:
      action: create_or_restore
      include:
        - profile: Opale Admin
          label: "QGIS - administration"
          desktop: true
          start_menu: true
        - profile: Opale Edition
          label: "QGIS - édition"
          desktop: true
          start_menu: true
        - profile: Opale Consultation
          label: "QGIS - consultation"
          desktop: true
          start_menu: true

  - name: Set splash screen
    uses: splash-screen-manager
    with:
      action: create_or_restore
      strict: false

  - name: Set default profile
    uses: default-profile-setter
    with:
      profile: Opale Consultation
